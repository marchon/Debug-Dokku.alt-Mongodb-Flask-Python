{"name":"Debug-dokku.alt-mongodb-flask-python","tagline":"My experiences, notes and sample code trying to debug MongoDB Flask Apps in Dokku-alt ","body":"Debugging  Dokku-alt / MONGODB / Flask / Python /  \r\n===============================================\r\n\r\nI have been trying for about 12 hours to debug my mongodb flask application with virtually no success...\r\nand then it hit me - assume EVERYTHING is broken and work backwards.\r\n\r\nI have recorded my experience to assist others including sharing my test code\r\n\r\nMy Debugging Checklist \r\n-------------------\r\n\r\n* [CHECK]  Are my imports were working\r\n* [CHECK]  Is mongodb loaded into dokku\r\n* [CHECK]  Is mongodb linked to my dokku app\r\n* [CHECK]  Is mongodb console for my dokku app working\r\n* [CHECK]  does my dokku environment have an environment variable for MONGODB_URL\r\n\r\n* ** [FAIL!]  does dokku user have authorization to connect via MONGODB_URL **\r\n\r\n\r\n##mongodb appears to be available in dokku\r\n\r\n```bash\r\nmarchon@modulo:~$ dokku | grep mongodb \r\n    mongodb:console <app> <db>                      Launch console for MongoDB container\r\n    mongodb:create <db>                             Create a MongoDB database\r\n    mongodb:delete <db>                             Delete specified MongoDB database\r\n    mongodb:dump <app> <db> <collection>            Dump database collection in bson for an app\r\n    mongodb:export <app> <db> <collection>          Export database collection for an app\r\n    mongodb:import <app> <db> <collection>          Import database collection for an app\r\n    mongodb:info <app> <db>                         Display application informations\r\n    mongodb:link <app> <db>                         Link database to app\r\n    mongodb:list <app>                              List linked databases\r\n    mongodb:restart                                 Restart MongoDB container (for example to switch image)\r\n    mongodb:unlink <app> <db>                       Unlink database from app\r\n```\r\n\r\n##mongodb appears to have a link to my dokku app\r\n\r\n```bash\r\n  marchon@modulo:~$ dokku mongodb:list todo\r\n  todo\r\n```\r\n##connecting to the mongodb shell for my app and database works\r\n\r\n```bash\r\n  marchon@modulo:~$ dokku mongodb:console todo todo\r\n  MongoDB shell version: 2.4.12\r\n  connecting to: mongodb:27017/todo\r\n  Welcome to the MongoDB shell.\r\n```\r\n\r\n##does dokku app instance have mongodb environment variables\r\nmongodb environment for my dokku app appears to have settings for host, port, username, password, and database\r\n\r\n```bash\r\n  marchon@modulo:~$ dokku mongodb:info todo todo\r\n\r\n  echo \"       Host: mongodb\"\r\n  echo \"       Port: 27017\"\r\n  echo \"       User: todo\"\r\n  echo \"       Password: mB09Ma7QMja45Bgc\"\r\n  echo \"       Database: todo\"\r\n  echo\r\n  echo \"       MONGODB_URL=mongodb://todo:mB09Ma7QMja45Bgc@mongodb:27017/todo\"\r\n```\r\n\r\n##do the dokku mongodb instance environment variables appear within the instance at runtime\r\n\r\nChecked with - inside of default route execution\r\n\r\n```python\r\n      d['URL'] = os.environ['MONGODB_URL']\r\n```\r\n\r\n```python\r\n@app.route('/')\r\ndef show_all():\r\n   try:\r\n     tasks = db.Task.find()\r\n     return render_template('list.html', tasks=tasks)\r\n   except Exception, e:\r\n     d = {}\r\n     d['Error'] = e.message\r\n     d['URL'] = os.environ['MONGODB_URL']\r\n     return render_template('page_not_found.html',d=d)\r\n```\r\n# [FAIL!]  does dokku user have authorization to connect via MONGODB_URL \r\n\r\ncommands for this user profile appear to lack authorization\r\n```bash\r\ndokku mongodb:console todo todo \r\n  MongoDB shell version: 2.4.12\r\n  connecting to: mongodb:27017/todo\r\n  Welcome to the MongoDB shell.\r\n  For interactive help, type \"help\".\r\n  For more comprehensive documentation, see\r\n  \thttp://docs.mongodb.org/\r\n  Questions? Try the support group\r\n  \thttp://groups.google.com/group/mongodb-user\r\n\r\n    > use todo\r\n    switched to db todo\r\n\r\n    > show profile\r\n    Thu Feb 26 08:53:01.577 count failed: { \"ok\" : 0, \"errmsg\" : \"unauthorized\" } at src/mongo/shell/query.js:180\r\n\r\n    > show dbs\r\n    Thu Feb 26 08:52:26.084 listDatabases failed:{ \"ok\" : 0, \"errmsg\" : \"unauthorized\" } at src/mongo/shell/mongo.js:46\r\n\r\n    > show users\r\n    Thu Feb 26 08:52:37.417 error: { \"$err\" : \"not authorized for query on todo.system.users\", \"code\" : 16550 } at src/mongo/shell/query.js:128\r\n\r\n    > show profile\r\n    Thu Feb 26 08:52:48.089 count failed: { \"ok\" : 0, \"errmsg\" : \"unauthorized\" } at src/mongo/shell/query.js:180\r\n\r\n    > use todo\r\n    switched to db todo\r\n\r\n    > show profile\r\n    Thu Feb 26 08:53:01.577 count failed: { \"ok\" : 0, \"errmsg\" : \"unauthorized\" } at src/mongo/shell/query.js:180\r\n\r\n    > show logs\r\n    Thu Feb 26 08:53:14.769 TypeError: Cannot read property 'length' of undefined at src/mongo/shell/utils.js:808\r\n\r\n    > use system\r\n    switched to db system\r\n    > show collections\r\n    Thu Feb 26 08:53:54.229 error: {\r\n    \t\"$err\" : \"not authorized for query on system.system.namespaces\",\r\n    \t\"code\" : 16550\r\n    } at src/mongo/shell/query.js:128\r\n```","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}