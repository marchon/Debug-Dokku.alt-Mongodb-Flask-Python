<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Debug-dokku.alt-mongodb-flask-python by marchon</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Debug-dokku.alt-mongodb-flask-python</h1>
        <p class="header">My experiences, notes and sample code trying to debug MongoDB Flask Apps in Dokku-alt </p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/marchon/Debug-Dokku.alt-Mongodb-Flask-Python/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/marchon/Debug-Dokku.alt-Mongodb-Flask-Python/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/marchon/Debug-Dokku.alt-Mongodb-Flask-Python">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/marchon">marchon</a></p>


      </header>
      <section>
        <h1>
<a id="debugging--dokku-alt--mongodb--flask--python---" class="anchor" href="#debugging--dokku-alt--mongodb--flask--python---" aria-hidden="true"><span class="octicon octicon-link"></span></a>Debugging  Dokku-alt / MONGODB / Flask / Python /  </h1>

<p>I have been trying for about 12 hours to debug my mongodb flask application with virtually no success...
and then it hit me - assume EVERYTHING is broken and work backwards.</p>

<p>I have recorded my experience to assist others including sharing my test code</p>

<h2>
<a id="my-debugging-checklist-" class="anchor" href="#my-debugging-checklist-" aria-hidden="true"><span class="octicon octicon-link"></span></a>My Debugging Checklist </h2>

<ul>
<li>[CHECK]  Are my imports were working</li>
<li>[CHECK]  Is mongodb loaded into dokku</li>
<li>[CHECK]  Is mongodb linked to my dokku app</li>
<li>[CHECK]  Is mongodb console for my dokku app working</li>
<li><p>[CHECK]  does my dokku environment have an environment variable for MONGODB_URL</p></li>
<li><p>** [FAIL!]  does dokku user have authorization to connect via MONGODB_URL **</p></li>
</ul>

<h2>
<a id="mongodb-appears-to-be-available-in-dokku" class="anchor" href="#mongodb-appears-to-be-available-in-dokku" aria-hidden="true"><span class="octicon octicon-link"></span></a>mongodb appears to be available in dokku</h2>

<div class="highlight highlight-bash"><pre>marchon@modulo:<span class="pl-k">~</span>$ dokku <span class="pl-k">|</span> grep mongodb 
    mongodb:console <span class="pl-k">&lt;</span>app<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>db<span class="pl-k">&gt;</span>                      Launch console <span class="pl-k">for</span> <span class="pl-vo">MongoDB</span> container
    mongodb:create <span class="pl-k">&lt;</span>db<span class="pl-k">&gt;</span>                             Create a MongoDB database
    mongodb:delete <span class="pl-k">&lt;</span>db<span class="pl-k">&gt;</span>                             Delete specified MongoDB database
    mongodb:dump <span class="pl-k">&lt;</span>app<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>db<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>collection<span class="pl-k">&gt;</span>            Dump database collection <span class="pl-k">in</span> bson <span class="pl-k">for</span> <span class="pl-vo">an</span> app
    mongodb:<span class="pl-s">export</span> <span class="pl-k">&lt;</span>app<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>db<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>collection<span class="pl-k">&gt;</span>          Export database collection <span class="pl-k">for</span> <span class="pl-vo">an</span> app
    mongodb:import <span class="pl-k">&lt;</span>app<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>db<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>collection<span class="pl-k">&gt;</span>          Import database collection <span class="pl-k">for</span> <span class="pl-vo">an</span> app
    mongodb:info <span class="pl-k">&lt;</span>app<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>db<span class="pl-k">&gt;</span>                         Display application informations
    mongodb:link <span class="pl-k">&lt;</span>app<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>db<span class="pl-k">&gt;</span>                         Link database to app
    mongodb:list <span class="pl-k">&lt;</span>app<span class="pl-k">&gt;</span>                              List linked databases
    mongodb:restart                                 Restart MongoDB container (<span class="pl-k">for</span> <span class="pl-vo">example</span> to switch image)
    mongodb:unlink <span class="pl-k">&lt;</span>app<span class="pl-k">&gt;</span> <span class="pl-k">&lt;</span>db<span class="pl-k">&gt;</span>                       Unlink database from app</pre></div>

<h2>
<a id="mongodb-appears-to-have-a-link-to-my-dokku-app" class="anchor" href="#mongodb-appears-to-have-a-link-to-my-dokku-app" aria-hidden="true"><span class="octicon octicon-link"></span></a>mongodb appears to have a link to my dokku app</h2>

<div class="highlight highlight-bash"><pre>  marchon@modulo:<span class="pl-k">~</span>$ dokku mongodb:list todo
  todo</pre></div>

<h2>
<a id="connecting-to-the-mongodb-shell-for-my-app-and-database-works" class="anchor" href="#connecting-to-the-mongodb-shell-for-my-app-and-database-works" aria-hidden="true"><span class="octicon octicon-link"></span></a>connecting to the mongodb shell for my app and database works</h2>

<div class="highlight highlight-bash"><pre>  marchon@modulo:<span class="pl-k">~</span>$ dokku mongodb:console todo todo
  MongoDB shell version: 2.4.12
  connecting to: mongodb:27017/todo
  Welcome to the MongoDB shell.</pre></div>

<h2>
<a id="does-dokku-app-instance-have-mongodb-environment-variables" class="anchor" href="#does-dokku-app-instance-have-mongodb-environment-variables" aria-hidden="true"><span class="octicon octicon-link"></span></a>does dokku app instance have mongodb environment variables</h2>

<p>mongodb environment for my dokku app appears to have settings for host, port, username, password, and database</p>

<div class="highlight highlight-bash"><pre>  marchon@modulo:<span class="pl-k">~</span>$ dokku mongodb:info todo todo

  <span class="pl-s3">echo</span> <span class="pl-s1"><span class="pl-pds">"</span>       Host: mongodb<span class="pl-pds">"</span></span>
  <span class="pl-s3">echo</span> <span class="pl-s1"><span class="pl-pds">"</span>       Port: 27017<span class="pl-pds">"</span></span>
  <span class="pl-s3">echo</span> <span class="pl-s1"><span class="pl-pds">"</span>       User: todo<span class="pl-pds">"</span></span>
  <span class="pl-s3">echo</span> <span class="pl-s1"><span class="pl-pds">"</span>       Password: mB09Ma7QMja45Bgc<span class="pl-pds">"</span></span>
  <span class="pl-s3">echo</span> <span class="pl-s1"><span class="pl-pds">"</span>       Database: todo<span class="pl-pds">"</span></span>
  <span class="pl-s3">echo</span>
  <span class="pl-s3">echo</span> <span class="pl-s1"><span class="pl-pds">"</span>       MONGODB_URL=mongodb://todo:mB09Ma7QMja45Bgc@mongodb:27017/todo<span class="pl-pds">"</span></span></pre></div>

<h2>
<a id="do-the-dokku-mongodb-instance-environment-variables-appear-within-the-instance-at-runtime" class="anchor" href="#do-the-dokku-mongodb-instance-environment-variables-appear-within-the-instance-at-runtime" aria-hidden="true"><span class="octicon octicon-link"></span></a>do the dokku mongodb instance environment variables appear within the instance at runtime</h2>

<p>Checked with - inside of default route execution</p>

<div class="highlight highlight-python"><pre>      d[<span class="pl-s1"><span class="pl-pds">'</span>URL<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> os.environ[<span class="pl-s1"><span class="pl-pds">'</span>MONGODB_URL<span class="pl-pds">'</span></span>]</pre></div>

<div class="highlight highlight-python"><pre><span class="pl-en">@</span><span class="pl-en">app.route</span>(<span class="pl-s1"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>)
<span class="pl-st">def</span> <span class="pl-en">show_all</span>():
   <span class="pl-k">try</span>:
     tasks <span class="pl-k">=</span> db.Task.find()
     <span class="pl-k">return</span> render_template(<span class="pl-s1"><span class="pl-pds">'</span>list.html<span class="pl-pds">'</span></span>, <span class="pl-vpf">tasks</span><span class="pl-k">=</span>tasks)
   <span class="pl-k">except</span> <span class="pl-s3">Exception</span>, e:
     d <span class="pl-k">=</span> {}
     d[<span class="pl-s1"><span class="pl-pds">'</span>Error<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> e.message
     d[<span class="pl-s1"><span class="pl-pds">'</span>URL<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> os.environ[<span class="pl-s1"><span class="pl-pds">'</span>MONGODB_URL<span class="pl-pds">'</span></span>]
     <span class="pl-k">return</span> render_template(<span class="pl-s1"><span class="pl-pds">'</span>page_not_found.html<span class="pl-pds">'</span></span>,<span class="pl-vpf">d</span><span class="pl-k">=</span>d)</pre></div>

<h1>
<a id="fail--does-dokku-user-have-authorization-to-connect-via-mongodb_url" class="anchor" href="#fail--does-dokku-user-have-authorization-to-connect-via-mongodb_url" aria-hidden="true"><span class="octicon octicon-link"></span></a>[FAIL!]  does dokku user have authorization to connect via MONGODB_URL</h1>

<p>commands for this user profile appear to lack authorization</p>

<div class="highlight highlight-bash"><pre>dokku mongodb:console todo todo 
  MongoDB shell version: 2.4.12
  connecting to: mongodb:27017/todo
  Welcome to the MongoDB shell.
  For interactive <span class="pl-s3">help</span>, <span class="pl-s3">type</span> <span class="pl-s1"><span class="pl-pds">"</span>help<span class="pl-pds">"</span></span>.
  For more comprehensive documentation, see
    http://docs.mongodb.org/
  Questions<span class="pl-k">?</span> Try the support group
    http://groups.google.com/group/mongodb-user

    <span class="pl-k">&gt;</span> use todo
    switched to db todo

    <span class="pl-k">&gt;</span> show profile
    Thu Feb 26 08:53:01.577 count failed: { <span class="pl-s1"><span class="pl-pds">"</span>ok<span class="pl-pds">"</span></span> <span class="pl-s3">:</span> 0, <span class="pl-s1"><span class="pl-pds">"</span>errmsg<span class="pl-pds">"</span></span> <span class="pl-s3">:</span> <span class="pl-s1"><span class="pl-pds">"</span>unauthorized<span class="pl-pds">"</span></span> } at src/mongo/shell/query.js:180

    <span class="pl-k">&gt;</span> show dbs
    Thu Feb 26 08:52:26.084 listDatabases failed:{ <span class="pl-s1"><span class="pl-pds">"</span>ok<span class="pl-pds">"</span></span> <span class="pl-s3">:</span> 0, <span class="pl-s1"><span class="pl-pds">"</span>errmsg<span class="pl-pds">"</span></span> <span class="pl-s3">:</span> <span class="pl-s1"><span class="pl-pds">"</span>unauthorized<span class="pl-pds">"</span></span> } at src/mongo/shell/mongo.js:46

    <span class="pl-k">&gt;</span> show users
    Thu Feb 26 08:52:37.417 error: { <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-vo">$err</span><span class="pl-pds">"</span></span> <span class="pl-s3">:</span> <span class="pl-s1"><span class="pl-pds">"</span>not authorized for query on todo.system.users<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span> <span class="pl-s3">:</span> 16550 } at src/mongo/shell/query.js:128

    <span class="pl-k">&gt;</span> show profile
    Thu Feb 26 08:52:48.089 count failed: { <span class="pl-s1"><span class="pl-pds">"</span>ok<span class="pl-pds">"</span></span> <span class="pl-s3">:</span> 0, <span class="pl-s1"><span class="pl-pds">"</span>errmsg<span class="pl-pds">"</span></span> <span class="pl-s3">:</span> <span class="pl-s1"><span class="pl-pds">"</span>unauthorized<span class="pl-pds">"</span></span> } at src/mongo/shell/query.js:180

    <span class="pl-k">&gt;</span> use todo
    switched to db todo

    <span class="pl-k">&gt;</span> show profile
    Thu Feb 26 08:53:01.577 count failed: { <span class="pl-s1"><span class="pl-pds">"</span>ok<span class="pl-pds">"</span></span> <span class="pl-s3">:</span> 0, <span class="pl-s1"><span class="pl-pds">"</span>errmsg<span class="pl-pds">"</span></span> <span class="pl-s3">:</span> <span class="pl-s1"><span class="pl-pds">"</span>unauthorized<span class="pl-pds">"</span></span> } at src/mongo/shell/query.js:180

    <span class="pl-k">&gt;</span> show logs
    Thu Feb 26 08:53:14.769 TypeError: Cannot <span class="pl-s3">read</span> property <span class="pl-s1"><span class="pl-pds">'</span>length<span class="pl-pds">'</span></span> of undefined at src/mongo/shell/utils.js:808

    <span class="pl-k">&gt;</span> use system
    switched to db system
    <span class="pl-k">&gt;</span> show collections
    Thu Feb 26 08:53:54.229 error: {
        <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-vo">$err</span><span class="pl-pds">"</span></span> <span class="pl-s3">:</span> <span class="pl-s1"><span class="pl-pds">"</span>not authorized for query on system.system.namespaces<span class="pl-pds">"</span></span>,
        <span class="pl-s1"><span class="pl-pds">"</span>code<span class="pl-pds">"</span></span> <span class="pl-s3">:</span> 16550
    } at src/mongo/shell/query.js:128</pre></div>
      </section>
      <footer>
        <p><small>Hosted on <a href="http://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
